<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herd Mentality</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e9;
        }
        .scoreboard-cow-icon {
            font-size: 1.5rem;
            color: #4b5563;
        }
        .pink-cow-icon {
            font-size: 2rem;
            color: #f687b3;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-yellow-100 to-green-200 min-h-screen flex items-center justify-center p-4 text-gray-800">
    <div class="max-w-4xl w-full bg-white rounded-3xl shadow-2xl p-8 flex flex-col items-center space-y-8">
        <h1 class="text-5xl font-extrabold text-gray-800 mb-2 flex items-center gap-4">
            Herd Mentality <i class="fas fa-cow text-4xl text-gray-600"></i>
        </h1>
        <p class="text-xl text-center text-gray-600 font-semibold mb-6">Think like the herd to win!</p>

        <!-- Loading and Error Messages -->
        <div id="status-message" class="text-center font-medium text-lg text-gray-700">Connecting to the pen...</div>
        <div id="error-message" class="text-center font-bold text-red-500 hidden"></div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="w-full flex flex-col items-center space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-800">Lobby</h2>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-8 w-full">
                <div class="bg-gray-100 rounded-xl p-6 shadow-inner w-full md:w-1/2">
                    <p class="text-xl font-semibold mb-2">Enter your name:</p>
                    <input type="text" id="player-name-input" placeholder="Your name" class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:border-green-500 transition duration-300 shadow-md">
                    <div class="mt-4 flex items-center">
                        <input type="checkbox" id="host-only-checkbox" class="form-checkbox h-5 w-5 text-green-600">
                        <label for="host-only-checkbox" class="ml-2 text-gray-700 font-medium">Host only (do not play)</label>
                    </div>
                    <p class="mt-4 text-gray-600 text-sm">Your internal ID is: <span id="user-id" class="font-mono text-sm bg-gray-200 px-2 py-1 rounded-md"></span></p>
                </div>
                <div class="flex-grow w-full md:w-1/2 flex flex-col space-y-4">
                    <button id="create-game-btn" class="bg-green-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-green-600 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Create New Game</button>
                    <div class="flex flex-col space-y-2">
                        <input id="join-game-id-input" type="text" placeholder="Enter 4-letter Game ID to Join" class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:border-green-500 transition duration-300 shadow-md">
                        <button id="join-game-btn" class="bg-blue-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-blue-600 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Join Existing Game</button>
                    </div>
                </div>
            </div>
            
            <div id="game-id-display" class="w-full flex flex-col items-center space-y-4 hidden">
                <p class="text-xl font-semibold">Your Game ID: <span id="lobby-game-id" class="font-mono text-lg bg-gray-200 px-3 py-1 rounded-md"></span></p>
                <button id="copy-game-id-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl hover:bg-gray-400 transition duration-300">
                    <i class="fas fa-copy mr-2"></i> Copy ID
                </button>
                <p class="text-gray-600">Share this ID with your friends so they can join.</p>
            </div>

            <div id="player-list-container" class="bg-gray-50 rounded-xl p-6 mt-6 w-full shadow-inner">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Players in Lobby</h3>
                <ul id="player-list" class="space-y-2"></ul>
                <div id="start-game-section" class="mt-6 flex justify-center hidden">
                    <button id="start-game-btn" class="bg-yellow-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-yellow-600 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Start Game</button>
                </div>
            </div>
        </div>

        <!-- Main Game Screen Content -->
        <div id="game-content" class="w-full flex flex-col items-center space-y-6 hidden">
            <!-- Game Screen -->
            <div id="game-screen" class="w-full flex flex-col items-center space-y-6">
                <div class="bg-yellow-50 rounded-xl p-6 shadow-inner w-full">
                    <p class="text-xl font-bold mb-2">Game ID: <span id="current-game-id" class="font-mono text-lg text-gray-600"></span></p>
                    <div id="current-question-container" class="text-center">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Question:</h2>
                        <p id="current-question" class="text-2xl font-semibold text-gray-700"></p>
                    </div>
                </div>

                <!-- Answer Input Section -->
                <div id="answer-section" class="w-full">
                    <label for="player-answer" class="block text-xl font-semibold text-gray-800 mb-2">Your Answer:</label>
                    <div class="flex flex-col space-y-4">
                        <input type="text" id="player-answer" class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:border-green-500 transition duration-300 shadow-md" placeholder="Write your answer here...">
                        <button id="submit-answer-btn" class="bg-green-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-green-600 transition duration-300 shadow-lg">Submit Answer</button>
                    </div>
                </div>

                <!-- Reveal Answer Section -->
                <div id="reveal-section" class="w-full hidden flex flex-col items-center space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">Answers submitted!</h3>
                    <button id="reveal-answers-btn" class="bg-blue-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-blue-600 transition duration-300 shadow-lg">Reveal Answers</button>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="w-full hidden">
                    <div class="bg-gray-50 rounded-xl p-6 shadow-inner w-full mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Round Results</h3>
                        <div id="answer-tally" class="space-y-4"></div>
                    </div>
                    <div class="flex justify-center space-x-4">
                        <button id="next-round-btn" class="bg-yellow-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-yellow-600 transition duration-300 shadow-lg">Next Round</button>
                        <button id="end-game-btn" class="bg-red-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-red-600 transition duration-300 shadow-lg hidden">End Game</button>
                    </div>
                </div>
            </div>

            <!-- Scoreboard -->
            <div id="scoreboard-container" class="bg-gray-50 rounded-xl p-6 shadow-inner w-full">
                <h3 id="scoreboard-title" class="text-2xl font-bold mb-4 text-gray-800">Scoreboard</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Player</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Cows</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Pink Cow</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboard-body" class="bg-white divide-y divide-gray-200">
                        <!-- Scoreboard rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Game Over Screen -->
            <div id="game-over-screen" class="w-full flex flex-col items-center space-y-4 hidden">
                <h2 class="text-4xl font-extrabold text-green-600">Game Over!</h2>
                <p id="winner-message" class="text-2xl text-center font-semibold text-gray-700"></p>
                <button id="play-again-btn" class="bg-green-500 text-white text-xl font-bold py-4 px-6 rounded-xl hover:bg-green-600 transition duration-300 shadow-lg">Play Again</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: For local deployment, you MUST replace these placeholders
        // with your own Firebase configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyAzLVJlX4hK8-vq_zHQrQsY8d6Sg8QFqnE",
            authDomain: "herd-mentality-f089b.firebaseapp.com",
            projectId: "herd-mentality-f089b",
            storageBucket: "herd-mentality-f089b.firebasestorage.app",
            messagingSenderId: "1052545056071",
            appId: "1:1052545056071:web:e5a314ff28f827bd616062",
            measurementId: "G-PP3Q3P74C5"
        };
        
        const appId = firebaseConfig.appId;

        let db;
        let auth;
        let userId;
        let currentGameId = null;
        let isHost = false;
        let isAuthReady = false;

        const statusMessageEl = document.getElementById('status-message');
        const errorMessageEl = document.getElementById('error-message');
        const lobbyScreenEl = document.getElementById('lobby-screen');
        const gameContentEl = document.getElementById('game-content');
        const gameScreenEl = document.getElementById('game-screen');
        const gameOverScreenEl = document.getElementById('game-over-screen');
        const userIdEl = document.getElementById('user-id');
        const playerNameInputEl = document.getElementById('player-name-input');
        const hostOnlyCheckboxEl = document.getElementById('host-only-checkbox');
        const playerListEl = document.getElementById('player-list');
        const currentQuestionEl = document.getElementById('current-question');
        const playerAnswerEl = document.getElementById('player-answer');
        const submitBtnEl = document.getElementById('submit-answer-btn');
        const revealBtnEl = document.getElementById('reveal-answers-btn');
        const nextRoundBtnEl = document.getElementById('next-round-btn');
        const scoreboardBodyEl = document.getElementById('scoreboard-body');
        const winnerMessageEl = document.getElementById('winner-message');
        const revealSectionEl = document.getElementById('reveal-section');
        const resultsSectionEl = document.getElementById('results-section');
        const answerSectionEl = document.getElementById('answer-section');
        const answerTallyEl = document.getElementById('answer-tally');
        const startGameSectionEl = document.getElementById('start-game-section');
        const scoreboardContainerEl = document.getElementById('scoreboard-container');

        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdDisplayEl = document.getElementById('game-id-display');
        const lobbyGameIdEl = document.getElementById('lobby-game-id');
        const joinGameIdInputEl = document.getElementById('join-game-id-input');
        const copyGameIdBtnEl = document.getElementById('copy-game-id-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const endGameBtn = document.getElementById('end-game-btn');

        const questions = [
            "Benda apa yang selalu hilang?",
            "Filem apa yang semua orang patut tonton?",
            "Aktiviti hujung minggu yang paling biasa?",
            "Haiwan apa yang anda tak nak jumpa dalam bilik mandi?",
            "Apa topping pizza yang paling sedap?",
            "Bandar yang paling romantik?",
            "Satu pekerjaan yang sangat membosankan?",
            "Satu perkara yang orang selalu berjanji tapi tak buat?",
            "Rasa aiskrim yang paling popular?",
            "Suara yang paling menjengkelkan?",
            "Jenama telefon pintar yang paling popular?",
            "Superpower yang paling tidak berguna?",
            "Benda apa yang selalu ada dalam beg tangan?",
            "Negara yang paling sejuk?",
            "Warna yang paling menenangkan?",
            "Benda yang anda selalu lupa?",
            "Makanan yang paling susah nak dibuang?",
            "Apa yang anda buat bila bosan?",
            "Lagu apa yang semua orang tahu?",
            "Tempat yang paling bagus untuk bercuti?",
            "Sayur yang paling disukai ramai?",
            "Bunga yang paling terkenal?",
            "Sukan apa yang paling susah?",
            "Filem seram yang paling menakutkan?",
            "Makanan yang paling sesuai untuk sarapan?",
            "Jenama kereta yang paling mewah?",
            "Selebriti yang paling mesra?",
            "Jenis kopi yang paling popular?",
            "Benda yang sentiasa ada dalam peti sejuk?",
            "Watak kartun yang paling ikonik?",
            "Pakaian yang paling selesa?",
            "Makanan segera yang paling disukai?",
            "Negara mana yang terkenal dengan makanan pedas?",
            "Wira super yang paling kuat?",
            "Minuman yang paling menyegarkan?",
            "Hari yang paling sibuk dalam seminggu?",
            "Makanan pencuci mulut yang paling sedap?",
            "Aktiviti yang paling menyeronokkan semasa hujan?",
            "Benda yang paling penting dalam hidup?",
            "Alat muzik yang paling mudah dipelajari?",
            "Buah yang paling popular?",
            "Haiwan peliharaan yang paling sesuai untuk kanak-kanak?",
            "Tempat yang paling menakutkan?",
            "Makanan yang paling unik?",
            "Benda yang anda tak boleh hidup tanpanya?",
            "Gaya rambut yang paling biasa?",
            "Raksasa filem yang paling terkenal?",
            "Makanan yang selalu orang bawa ke parti?",
            "Benda yang anda buat bila tak ada internet?",
            "Hobi yang paling popular?",
            "Apa yang anda akan lakukan jika anda memenangi loteri?",
            "Satu benda yang orang selalu beli tapi jarang guna?",
            "Makanan yang paling tak suka?",
            "Suara yang paling menenangkan?",
            "Apa yang anda tak patut pakai di majlis perkahwinan?",
            "Jenama kasut yang paling terkenal?",
            "Perkataan yang paling kerap anda gunakan?",
            "Makanan yang paling pedas?",
            "Apa yang anda akan makan untuk kali terakhir jika anda boleh pilih?",
            "Tempat yang paling ramai orang pergi?"
        ];
        
        function generateShortId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function setupFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase configuration is missing or empty. Please replace the placeholder values.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            unsubscribe();
                            resolve();
                        }
                    });
                });
                
                statusMessageEl.textContent = "Connected to the pen! Ready to play.";
                userIdEl.textContent = userId;
                createGameBtn.disabled = false;
                joinGameBtn.disabled = false;
                
                showLobby();
                console.log("Firebase setup complete. Game is ready.");
            } catch (e) {
                console.error("Firebase setup failed: ", e);
                errorMessageEl.textContent = `Error connecting to Firebase: ${e.message}. Please check the console and your Firebase configuration.`;
                errorMessageEl.classList.remove('hidden');
                statusMessageEl.classList.add('hidden');
            }
        }
        
        function showLobby() {
            lobbyScreenEl.classList.remove('hidden');
            gameContentEl.classList.add('hidden');
            gameOverScreenEl.classList.add('hidden');
        }

        function showGame() {
            lobbyScreenEl.classList.add('hidden');
            gameContentEl.classList.remove('hidden');
            gameScreenEl.classList.remove('hidden');
            gameOverScreenEl.classList.add('hidden');
            scoreboardContainerEl.classList.remove('hidden');
        }

        function showGameOver() {
            lobbyScreenEl.classList.add('hidden');
            gameContentEl.classList.remove('hidden');
            gameScreenEl.classList.add('hidden');
            gameOverScreenEl.classList.remove('hidden');
            scoreboardContainerEl.classList.remove('hidden');
        }
        
        function validateName() {
            const playerName = playerNameInputEl.value.trim();
            if (!playerName) {
                errorMessageEl.textContent = "Please enter a name to play.";
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                return null;
            }
            return playerName;
        }

        async function createGame() {
            if (!isAuthReady) return;
            const playerName = validateName();
            if (!playerName) return;

            const isHostOnly = hostOnlyCheckboxEl.checked;
            
            const newGameRef = doc(collection(db, `artifacts/${appId}/public/data/games`));
            const newGameId = newGameRef.id;
            let shortId;
            let shortIdRef;

            let isUnique = false;
            let retries = 0;
            const maxRetries = 10;
            do {
                shortId = generateShortId();
                shortIdRef = doc(db, `artifacts/${appId}/public/data/shortGameIds/${shortId}`);
                const shortIdSnap = await getDoc(shortIdRef);
                if (!shortIdSnap.exists()) {
                    isUnique = true;
                }
                retries++;
            } while (!isUnique && retries < maxRetries);

            if (!isUnique) {
                errorMessageEl.textContent = "Failed to generate a unique game ID. Please try again.";
                errorMessageEl.classList.remove('hidden');
                return;
            }

            const players = isHostOnly ? {} : { [userId]: { name: playerName, score: 0, pinkCowCount: 0 } };

            const initialGameState = {
                players: players,
                hostId: userId,
                round: 0,
                status: 'lobby',
                answers: {},
                question: null,
                shortId: shortId,
                currentPinkCowHolderId: null,
            };

            try {
                await setDoc(newGameRef, initialGameState);
                await setDoc(shortIdRef, { longId: newGameId });
                
                currentGameId = newGameId;
                isHost = true;
                listenToGameChanges();
            } catch (e) {
                console.error("Error creating game: ", e);
                errorMessageEl.textContent = "Failed to create game. Please try again.";
                errorMessageEl.classList.remove('hidden');
            }
        }

        async function joinGame() {
            if (!isAuthReady) return;
            const playerName = validateName();
            if (!playerName) return;

            const joinGameShortId = joinGameIdInputEl.value.trim().toUpperCase();
            if (!joinGameShortId || joinGameShortId.length !== 4) {
                errorMessageEl.textContent = "Please enter a valid 4-letter Game ID.";
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                return;
            }

            try {
                const shortIdRef = doc(db, `artifacts/${appId}/public/data/shortGameIds/${joinGameShortId}`);
                const shortIdSnap = await getDoc(shortIdRef);
                
                if (!shortIdSnap.exists()) {
                    errorMessageEl.textContent = "Game not found. Please check the ID.";
                    errorMessageEl.classList.remove('hidden');
                    setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                    return;
                }

                const longGameId = shortIdSnap.data().longId;
                const gameRef = doc(db, `artifacts/${appId}/public/data/games/${longGameId}`);
                const gameSnap = await getDoc(gameRef);

                if (gameSnap.exists()) {
                    const gameData = gameSnap.data();
                    const newPlayers = { ...gameData.players };
                    
                    if (newPlayers[userId]) {
                        newPlayers[userId].name = playerName;
                    } else {
                        newPlayers[userId] = { name: playerName, score: 0, pinkCowCount: 0 };
                    }
                    
                    await setDoc(gameRef, { players: newPlayers }, { merge: true });
                    
                    currentGameId = longGameId;
                    isHost = gameData.hostId === userId;
                    listenToGameChanges();
                } else {
                    errorMessageEl.textContent = "Game not found. Please check the ID.";
                    errorMessageEl.classList.remove('hidden');
                    setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                }
            } catch (e) {
                console.error("Error joining game: ", e);
                errorMessageEl.textContent = "Failed to join game. Please try again.";
                errorMessageEl.classList.remove('hidden');
            }
        }
        
        function listenToGameChanges() {
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    const gameData = doc.data();
                    updateUI(gameData);
                } else {
                    errorMessageEl.textContent = "Game has ended or was deleted.";
                    errorMessageEl.classList.remove('hidden');
                    setTimeout(() => window.location.reload(), 3000);
                }
            }, (error) => {
                console.error("Error listening to game changes: ", error);
            });
        }
        
        function updateUI(gameData) {
            isHost = gameData.hostId === userId;
            
            if (gameData.shortId) {
                document.getElementById('current-game-id').textContent = gameData.shortId;
                lobbyGameIdEl.textContent = gameData.shortId;
            }

            const playerNames = Object.values(gameData.players).map(p => p.name);
            playerListEl.innerHTML = playerNames.map(name => `<li class="font-medium text-gray-700"><i class="fas fa-user-circle text-green-500 mr-2"></i>${name}</li>`).join('');

            if (gameData.status === 'lobby') {
                showLobby();
                if (isHost && gameData.shortId) {
                    gameIdDisplayEl.classList.remove('hidden');
                    startGameSectionEl.classList.remove('hidden');
                    const playerCount = Object.keys(gameData.players).length;
                    if (playerCount > 2) {
                        startGameBtn.disabled = false;
                    } else {
                        startGameBtn.disabled = true;
                    }
                } else if (gameData.shortId) {
                    gameIdDisplayEl.classList.add('hidden');
                } else {
                    gameIdDisplayEl.classList.add('hidden');
                }
            } else if (gameData.status === 'writing') {
                showGame();
                currentQuestionEl.textContent = gameData.question;
                
                if (gameData.players[userId]) {
                    answerSectionEl.classList.remove('hidden');
                } else {
                    answerSectionEl.classList.add('hidden');
                }
                
                revealSectionEl.classList.add('hidden');
                resultsSectionEl.classList.add('hidden');
                
                if (gameData.answers[userId]) {
                    playerAnswerEl.disabled = true;
                    submitBtnEl.disabled = true;
                    submitBtnEl.textContent = "Answer Submitted!";
                    
                    const allPlayersAnswered = Object.keys(gameData.answers).length === Object.keys(gameData.players).length;
                    if (isHost && allPlayersAnswered) {
                        revealSectionEl.classList.remove('hidden');
                    }
                } else {
                    playerAnswerEl.disabled = false;
                    submitBtnEl.disabled = false;
                    submitBtnEl.textContent = "Submit Answer";
                    
                    // Only clear the input box if no one has submitted an answer yet.
                    if (Object.keys(gameData.answers).length === 0) {
                       playerAnswerEl.value = "";
                    }
                }
            } else if (gameData.status === 'revealing') {
                showGame();
                answerSectionEl.classList.add('hidden');
                revealSectionEl.classList.add('hidden');
                resultsSectionEl.classList.remove('hidden');
                displayRoundResults(gameData);
                if (isHost) {
                    nextRoundBtnEl.classList.remove('hidden');
                    endGameBtn.classList.remove('hidden');
                } else {
                    nextRoundBtnEl.classList.add('hidden');
                    endGameBtn.classList.add('hidden');
                }
            } else if (gameData.status === 'game_over') {
                showGameOver();
                updateScoreboard(gameData.players, gameData.currentPinkCowHolderId);
                document.getElementById('scoreboard-title').textContent = "Final Leaderboard";
                
                const potentialWinners = Object.keys(gameData.players).filter(pId => {
                    const player = gameData.players[pId];
                    return player.score >= 8 && pId !== gameData.currentPinkCowHolderId;
                });
                
                if (potentialWinners.length === 1) {
                    const winnerName = gameData.players[potentialWinners[0]].name;
                    winnerMessageEl.textContent = `${winnerName} is the champion of the herd!`;
                } else if (potentialWinners.length > 1) {
                    const winnerNames = potentialWinners.map(pId => gameData.players[pId].name).join(' and ');
                    winnerMessageEl.textContent = `It's a tie! Congratulations to ${winnerNames}!`;
                } else {
                    winnerMessageEl.textContent = "Game Over! The herd couldn't decide on a champion.";
                }
            }

            if (gameData.status !== 'game_over') {
                updateScoreboard(gameData.players, gameData.currentPinkCowHolderId);
                document.getElementById('scoreboard-title').textContent = "Scoreboard";
            }
        }
        
        async function startGame() {
            if (!isHost) return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            const newQuestion = questions[Math.floor(Math.random() * questions.length)];
            
            try {
                await setDoc(gameRef, {
                    status: 'writing',
                    question: newQuestion,
                    answers: {},
                    round: 1,
                }, { merge: true });
            } catch (e) {
                console.error("Error starting game: ", e);
            }
        }

        async function startNewRound() {
            if (!isHost) return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            const gameData = gameSnap.data();

            const newQuestion = questions[Math.floor(Math.random() * questions.length)];
            
            try {
                await setDoc(gameRef, {
                    status: 'writing',
                    question: newQuestion,
                    answers: {},
                    round: gameData.round + 1,
                }, { merge: true });
            } catch (e) {
                console.error("Error starting new round: ", e);
            }
        }

        async function endGameManually() {
            if (!isHost) return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            
            try {
                await setDoc(gameRef, { status: 'game_over' }, { merge: true });
            } catch (e) {
                console.error("Error ending game manually: ", e);
            }
        }
        
        async function submitAnswer() {
            const answer = playerAnswerEl.value.trim();
            if (!answer) {
                errorMessageEl.textContent = "Please write an answer first.";
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                return;
            }
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            
            try {
                await setDoc(gameRef, {
                    answers: { [userId]: answer }
                }, { merge: true });
            } catch (e) {
                console.error("Error submitting answer: ", e);
            }
        }

        async function revealAnswers() {
            if (!isHost) return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}`);
            
            const gameSnap = await getDoc(gameRef);
            const gameData = gameSnap.data();
            
            const answers = gameData.answers;
            const players = gameData.players;

            const answerCounts = {};
            Object.values(answers).forEach(answer => {
                const normalizedAnswer = answer.toLowerCase();
                answerCounts[normalizedAnswer] = (answerCounts[normalizedAnswer] || 0) + 1;
            });

            let majorityCount = 0;
            let majorityAnswer = null;
            let tiedMajority = false;

            for (const answer in answerCounts) {
                if (answerCounts[answer] > majorityCount) {
                    majorityCount = answerCounts[answer];
                    majorityAnswer = answer;
                    tiedMajority = false;
                } else if (answerCounts[answer] === majorityCount) {
                    tiedMajority = true;
                }
            }

            const oddOnesOut = Object.keys(answers).filter(pId => {
                const playerAnswer = answers[pId];
                return answerCounts[playerAnswer.toLowerCase()] === 1;
            });
            
            const newPlayers = JSON.parse(JSON.stringify(players));
            let newCurrentPinkCowHolderId = gameData.currentPinkCowHolderId;
            let gameWinner = false;
            
            if (!tiedMajority) {
                Object.keys(newPlayers).forEach(pId => {
                    const playerAnswer = answers[pId];
                    if (playerAnswer && playerAnswer.toLowerCase() === majorityAnswer) {
                        newPlayers[pId].score += 1;
                    }
                });
            }

            if (oddOnesOut.length === 1) {
                const pinkCowHolderId = oddOnesOut[0];
                newPlayers[pinkCowHolderId].pinkCowCount += 1;
                newCurrentPinkCowHolderId = pinkCowHolderId;
            }
            
            const potentialWinners = Object.keys(newPlayers).filter(pId => {
                const player = newPlayers[pId];
                return player.score >= 8 && pId !== newCurrentPinkCowHolderId;
            });

            if (potentialWinners.length >= 1) {
                gameWinner = true;
            }
            
            try {
                await setDoc(gameRef, {
                    status: gameWinner ? 'game_over' : 'revealing',
                    players: newPlayers,
                    currentPinkCowHolderId: newCurrentPinkCowHolderId,
                }, { merge: true });
            } catch (e) {
                console.error("Error revealing answers: ", e);
            }
        }

        function displayRoundResults(gameData) {
            answerTallyEl.innerHTML = "";
            const answers = gameData.answers;
            const playerNames = gameData.players;
            
            const groupedAnswers = {};
            for (const pId in answers) {
                const normalizedAnswer = answers[pId].toLowerCase();
                if (!groupedAnswers[normalizedAnswer]) {
                    groupedAnswers[normalizedAnswer] = {
                        originalAnswer: answers[pId],
                        players: [],
                    };
                }
                groupedAnswers[normalizedAnswer].players.push(playerNames[pId].name);
            }
            
            const sortedAnswers = Object.values(groupedAnswers).sort((a, b) => b.players.length - a.players.length);

            sortedAnswers.forEach(({ originalAnswer, players }) => {
                const isMajority = players.length === sortedAnswers[0].players.length;
                const isOddOneOut = players.length === 1;
                
                const resultText = document.createElement('div');
                resultText.className = "p-4 border-2 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105";
                
                if (isMajority && (!sortedAnswers[1] || sortedAnswers[1].players.length < players.length)) {
                    resultText.classList.add('bg-green-100', 'border-green-400');
                    resultText.innerHTML = `<p class="text-xl font-bold text-green-700 flex items-center gap-2"><i class="fas fa-check-circle"></i> "${originalAnswer}"</p><p class="mt-2 text-lg text-green-600">Matched by: ${players.join(', ')}</p>`;
                } else if (isOddOneOut) {
                    resultText.classList.add('bg-red-100', 'border-red-400');
                    resultText.innerHTML = `<p class="text-xl font-bold text-red-700 flex items-center gap-2"><i class="fas fa-times-circle"></i> "${originalAnswer}"</p><p class="mt-2 text-lg text-red-600">The Odd One Out: ${players.join(', ')}</p>`;
                } else {
                    resultText.classList.add('bg-gray-100', 'border-gray-400');
                    resultText.innerHTML = `<p class="text-xl font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-minus-circle"></i> "${originalAnswer}"</p><p class="mt-2 text-lg text-gray-600">Matched by: ${players.join(', ')}</p>`;
                }
                answerTallyEl.appendChild(resultText);
            });
        }

        function updateScoreboard(players, currentPinkCowHolderId) {
            scoreboardBodyEl.innerHTML = "";
            const sortedPlayerIds = Object.keys(players).sort((a, b) => players[b].score - players[a].score);
            
            sortedPlayerIds.forEach(pId => {
                const player = players[pId];
                const isCurrentPinkCowHolder = pId === currentPinkCowHolderId;
                
                const row = document.createElement('tr');
                let rowClasses = "border-b border-gray-200";
                
                if (isCurrentPinkCowHolder) {
                    rowClasses += " bg-pink-100 font-semibold";
                }
                row.className = rowClasses;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${player.score}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                        ${isCurrentPinkCowHolder ? `<i class="fas fa-cow pink-cow-icon"></i> ${player.pinkCowCount}` : `${player.pinkCowCount}`}
                    </td>
                `;
                scoreboardBodyEl.appendChild(row);
            });
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = event.target.textContent;
                    event.target.textContent = 'Copied!';
                    setTimeout(() => {
                        event.target.textContent = originalText;
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy text with Clipboard API: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalText = event.target.textContent;
                    event.target.textContent = 'Copied!';
                    setTimeout(() => {
                        event.target.textContent = originalText;
                    }, 1500);
                } else {
                    errorMessageEl.textContent = "Failed to copy. Please copy manually.";
                    errorMessageEl.classList.remove('hidden');
                    setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                errorMessageEl.textContent = "Failed to copy. Please copy manually.";
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);
            }

            document.body.removeChild(textArea);
        }

        setupFirebase();

        document.addEventListener('DOMContentLoaded', () => {
            const submitAnswerBtn = document.getElementById('submit-answer-btn');
            const revealAnswersBtn = document.getElementById('reveal-answers-btn');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const playAgainBtn = document.getElementById('play-again-btn');

            if (createGameBtn) createGameBtn.addEventListener('click', createGame);
            if (joinGameBtn) joinGameBtn.addEventListener('click', joinGame);
            if (startGameBtn) startGameBtn.addEventListener('click', startGame);
            if (submitAnswerBtn) submitAnswerBtn.addEventListener('click', submitAnswer);
            if (revealAnswersBtn) revealAnswersBtn.addEventListener('click', revealAnswers);
            if (nextRoundBtn) nextRoundBtn.addEventListener('click', startNewRound);
            if (playAgainBtn) playAgainBtn.addEventListener('click', () => window.location.reload());
            if (copyGameIdBtnEl) copyGameIdBtnEl.addEventListener('click', () => {
                copyToClipboard(lobbyGameIdEl.textContent);
            });
            if (endGameBtn) endGameBtn.addEventListener('click', endGameManually);
        });
    </script>
</body>
</html>
